name: Sync with Latest Release

on:
  schedule:
    - cron: '0 0 * * *'  # Runs daily at midnight UTC
  workflow_dispatch:     # Allow manual triggering

jobs:
  sync-with-release:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Get full history for commit count

    - name: Add upstream remote
      run: |
        git remote add upstream https://github.com/ggml-org/llama.cpp.git
        git fetch upstream --tags  # Fetch tags from upstream

    - name: Sync master with latest release
      run: |
        git checkout master
        LATEST_RELEASE=$(git describe --tags --abbrev=0 upstream/master)
        git reset --hard $LATEST_RELEASE
        git push origin master --force

    - name: Rebase dev onto master
      run: |
        git checkout dev
        if ! git rebase master; then
            echo "Rebase conflict detected, aborting"
            git rebase --abort
            exit 1
        fi
        git push origin dev --force-with-lease

    - name: Create version tag
      run: |
        git checkout master
        COMMIT_COUNT=$(git rev-list --count HEAD)
        git checkout dev
        git tag "b${COMMIT_COUNT}"
        git push origin tag "b${COMMIT_COUNT}"
